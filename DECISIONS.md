# DECISIONS.md – Registro de Decisiones

## Cambios recientes
2025-12-15 – **Permisos de ubicación con @capacitor/geolocation** – Se instala `@capacitor/geolocation@6.1.1` para solicitar permisos de ubicación de forma proactiva al abrir la app nativa. Se agregan permisos `ACCESS_COARSE_LOCATION`, `ACCESS_FINE_LOCATION` y feature `android.hardware.location.gps` al `AndroidManifest.xml`. Se crea `src/lib/geolocation.ts` con funciones de permisos y `LocationPermissionGate` que envuelve la app en `layout.tsx` para pedir permisos al iniciar. En web, el navegador sigue pidiendo permisos automáticamente.
2025-12-15 – **Icono final con ambulancia.png personalizada** – Se usa `assets/ambulancia.png` (imagen PNG negra) como fuente; sharp invierte colores (blanco) y compone sobre fondo rojo circular (#DC2626). Flujo: editar ambulancia.png → generar icon.png con script Node → ejecutar `npm run generate:assets`. Corrige la decisión anterior que usaba SVGs generados por código.
2025-12-15 – **Iconos personalizados para PWA/Android/iOS** – Se implementan iconos personalizados (ambulancia blanca sobre fondo rojo #DC2626). Herramientas: sharp para procesar imágenes y `npm run generate:assets` (@capacitor/assets). PWA usa `public/icons/`, Android usa `mipmap-*/` con Adaptive Icons. Se agregan `favicon.ico` y `apple-touch-icon.png` en `public/`. Layout.tsx actualizado para usar `/icons/favicon.png`. ESLint ignora `scripts/**`. Documentación en `docs/appstore-packaging.md`.
2025-12-15 – **Instalación APK desde WSL con wslpath** – Para instalar APKs en emulador Windows desde WSL, usar `wslpath -w <ruta>` para convertir rutas Linux a Windows (ej: `adb.exe install -r "$(wslpath -w /ruta.apk)"`). Recordar setear `JAVA_HOME` a JDK 17 para builds Gradle.
2025-12-12 – **Home: orden de pantalla + patrocinio solo superior** – Se reordena la pantalla principal para seguir el layout del prototipo (CTA ambulancia, grid 2x2, botón inferior de centros) y se elimina el banner/imagen de patrocinio del pie, dejando **solo el superior** (reemplaza la decisión 2025-12-10 de “top y pie”).
2025-12-12 – **Seguridad deps: Next patch upgrade** – Se actualizan `next` y `eslint-config-next` a **16.0.10** para mantener parches al día y dejar `npm audit` en 0.
2025-12-12 – **Remote Config: refresh al volver online** – Se fuerza un fetch/activate en background (1 vez por sesión) cuando hay internet al iniciar o cuando vuelve la conectividad, para aplicar cambios publicados sin esperar el TTL de 24h.
2025-12-12 – **Remote Config: números `offline_*` + SMS configurable** – Se agregan claves `offline_*_phone`, `samco_sms_phone` y `sms_help_body_template` (placeholders) para controlar números “generales” y el cuerpo del SMS desde Remote Config, manteniendo cache offline.
2025-12-12 – **Geofence multi-servicio** – Además de ambulancia, policía/bomberos/monitoreo cambian entre número local (`*_phone`) y general (`offline_*_phone`) según geofence.
2025-12-12 – **SMS útil sin Maps** – El SMS siempre incluye coordenadas en texto plano y soporta placeholders `{{mapsUrl}}/{{coords}}/{{lat}}/{{lon}}` para que sea legible incluso sin internet.
2025-12-12 – **ESLint ignora `out/**`** – Se excluye el export estático del lint para evitar errores sobre artefactos generados.
2025-12-12 – **Deploy Android (WSL → emulador Windows)** – Para instalar en AVD de Windows desde WSL, se usa `adb.exe` del SDK de Windows; el build Gradle requiere JDK 17.
2025-12-12 – **Capacitor offline-first (bundle local)** – Se adopta export estático de Next (`output: "export"` → `out/`) y Capacitor carga assets locales (`webDir: "out"`, sin `server.url`) para que la app funcione sin internet desde el primer arranque; `trailingSlash` se desactiva por compatibilidad con el asset server de Capacitor.
2025-12-12 – **Rutas dinámicas exportables para stores** – Se adapta `/educacion/[slug]` a export estático (parámetros pre-generados + wrapper cliente) para que funcione en `out/` dentro de Capacitor (Android/iOS).
2025-12-11 – **Parche CVEs npm (overrides)** – Se fijan versiones seguras con overrides (`axios` 1.13.2, `@modelcontextprotocol/sdk` 1.24.3 + `body-parser` 2.2.1, `glob` 10.5.0 → luego 9.3.5 por compat, `brace-expansion` 2.0.2, `@babel/runtime` 7.28.4) y se sube `patch-package` a 8.0.1 para cerrar vulnerabilidades; `npm audit` queda en 0.
2025-12-11 – **Compat glob (build Next/PWA)** – Se ajusta override de `glob` a 9.3.5 (CJS) para evitar error `pify(...).bind` al cargar `next.config.ts`; build vuelve a pasar (`npm run build`).
2025-12-11 – **Gitignore Android endurecido** – `android/.gitignore` ahora excluye keystores (`*.jks`, `*.keystore`, `*.p12`, `*.pem`) y `google-services.json` en cualquier ruta para prevenir filtrado de credenciales.
2025-12-11 – **Capacitor Android base** – Añadidos @capacitor/core/cli/android, `capacitor.config.ts` (appId `com.susamco.emergenciaya`, webDir `.next`, server `https://emergencia-ya.vercel.app`) y proyecto `android/` para empaquetar APK/AAB offline.
2025-12-11 – **Build Android con SDK local** – Generados APK debug y AAB release tras `npx cap sync android` y Gradle con JDK 17 (Zulu en `~/.jdks/...`) y Android SDK en `~/Android`; se añade `android/local.properties` con `sdk.dir` para compilar sin sudo; emulador con conectividad solo al arrancar sin snapshots (`-dns-server 8.8.8.8,1.1.1.1`, `-no-snapshot-load`).
2025-12-11 – **Arranque emulador sin snapshots** – Para evitar pérdida de red en el AVD, se define flujo: iniciar por consola con `emulator.exe -avd <AVD> -dns-server 8.8.8.8,1.1.1.1 -no-snapshot-load -no-snapshot-save`; si se usa Device Manager, aplicar Wipe Data + Cold Boot y desactivar snapshots.
2025-12-11 – **Remote Config snapshot Dexie** – Dexie v4 agrega `remoteConfigSnapshots` y el hook adopta/actualiza snapshots hashados, permitiendo usar datos RC offline y actualizar solo si cambian.
2025-12-11 – **Doc comandos Android** – `docs/appstore-packaging.md` incluye pasos rápidos (build, cap sync/open) para generar/aprobar APK/AAB.
2025-12-11 – **ESLint ignora android/** – Se excluye `android/**` en la flat config para evitar falsos positivos sobre assets generados por Capacitor.
2025-12-10 – **PWA caching nav NetworkFirst y assets SWR** – Ajustado runtime caching: navegación NetworkFirst (timeout 5s, 7d) y assets StaleWhileRevalidate manteniendo fallback `/offline`.
2025-12-10 – **Fallback offline con números directos** – Página offline (React y HTML) ahora muestra botones de llamada a números críticos por defecto para uso sin datos.
2025-12-10 – **Remote Config v1 versionada** – Claves y cache de Remote Config con versión v1, TTL 24h y limpieza de storage legacy para evitar datos viejos.
2025-12-10 – **Outbox con backoff** – Dexie v3 añade attempts/nextAttemptAt y sync usa backoff exponencial con límite de intentos para evitar bucles en offline.
2025-12-10 – **Manifest webmanifest alineado** – `manifest.webmanifest` ahora usa los íconos PNG/maskable reales como `manifest.json`.
2025-12-10 – **ESLint flat config (mjs)** – Migrado a `eslint.config.mjs` (flat) para compatibilidad con ESLint 9 sin warnings.
2025-12-10 – **Guía empaquetado stores** – Creado `docs/appstore-packaging.md` con pasos Capacitor/TWA, checklist de permisos, assets y pruebas.
2025-12-10 – **Next.js 16.0.8 (CVE-2025-66478)** – Actualizados `next` y `eslint-config-next` a 16.0.8 para cumplir el requisito de seguridad de Vercel; se regeneró `package-lock.json`.
2025-12-10 – **Config PWA unificada** – Eliminado `src/next.config.ts` duplicado; se mantiene `next.config.ts` en raíz con fallback offline en `/offline` (App Router).
2025-12-10 – **Deps Genkit/ESLint compatibles Next16** – Actualizadas dependencias @genkit-ai a 1.25.0 (core, next, googleai), ESLint a v9 y zod a ^3.25.x para alinear peer deps y permitir instalaciones/builds en Next 16 (Vercel).
2025-12-10 – **Linting con ESLint CLI y typegen** – Se reemplazó `next lint` eliminado en v16 por `eslint . --max-warnings=0` usando configuración básica `eslint:recommended` + `@typescript-eslint/recommended`, ignorando artefactos generados (`public/**`, `.next`). Se añadió script `next typegen` para generar tipos en CI.
2025-12-10 – **Next.js 16.0.7 (parche React2Shell)** – Actualizado Next a 16.0.7 para mitigar CVE-2025-55182; se fuerza webpack en dev/build (`next dev --webpack`, `next build --webpack`) por compatibilidad con `next-pwa`. Se eliminó `eslint` del `next.config` (ya no soportado en v16).
2025-12-10 – **Next.js App Router + PWA** – Se usa Next.js 15 con App Router y next-pwa; navegación/estáticos en CacheFirst y fallback `/offline`.
2025-12-10 – **Caché de videos educativos** – CacheFirst para videos de Firebase Storage (20 entradas, 30 días) para disponibilidad offline.
2025-12-10 – **Remote Config con defaults embebidos** – Config por defecto en bundle; fetch/activate cada 24h (localStorage). Si RC falla, se usan defaults.
2025-12-10 – **Geofence para número de ambulancia** – Centro Armstrong (-32.7833, -61.6), radio 10 km. Dentro del área se usa número local; fuera o sin ubicación, 107.
2025-12-10 – **Contenido educativo mixto** – Tópicos y pasos en JSON local; URLs de video provistas por Remote Config por slug.
2025-12-10 – **Datos locales y sincronización** – Dexie DB para almacenamiento offline y outbox; sync a Firestore con `sync()` (sin backoff, reemplazado luego por entrada “Outbox con backoff” del mismo día).
2025-12-10 – **Build tolerante a errores** – `typescript.ignoreBuildErrors` y `eslint.ignoreDuringBuilds` activados para no bloquear builds.
2025-12-10 – **Distribución mobile-first** – PWA instalable (manifest, icons, theme_color) como base para empaquetar en tiendas a futuro.
2025-12-10 – **Banners patrocinio Fundación Nazareno Crucianelli** – Imagen estática `public/logo-fundacion-blanca.jpeg` en home (top y pie) para crédito de patrocinio sin alterar CTA principal.
